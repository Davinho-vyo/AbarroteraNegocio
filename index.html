// Proyecto: Mi Tiendita - Mejoras y Expansión (React + Tailwind)

// ✅ 1. CORREGIR BUG DE GUARDADO DE DATOS + EXTENSIÓN DE HISTORIAL
export function usePersistencia({ resumenDia, inventario, ventas, setInventario, setVentas }) {
  const claveDatos = 'miTiendita_datos';
  const claveHistorico = 'miTiendita_historico';
  const hoy = new Date().toLocaleDateString('es-MX');

  const guardarDatos = () => {
    const datos = {
      fecha: hoy,
      inventario,
      ventas,
      resumen: resumenDia
    };
    localStorage.setItem(claveDatos, JSON.stringify(datos));
  };

  const guardarDiaEnHistorico = (datos) => {
    const historico = JSON.parse(localStorage.getItem(claveHistorico) || '[]');
    historico.unshift(datos);
    if (historico.length > 90) historico.length = 90;
    localStorage.setItem(claveHistorico, JSON.stringify(historico));
  };

  const cargarDatosDelDia = () => {
    try {
      const datosGuardados = localStorage.getItem(claveDatos);
      if (datosGuardados) {
        const datos = JSON.parse(datosGuardados);
        if (datos.fecha === hoy) {
          setInventario(datos.inventario || []);
          setVentas(datos.ventas || []);
        } else {
          guardarDiaEnHistorico(datos);
          setInventario(datos.inventario || []);
          setVentas([]);
        }
      }
    } catch (e) {
      console.error('Error cargando datos:', e);
      setInventario([]);
      setVentas([]);
    }
  };

  return { guardarDatos, cargarDatosDelDia };
}

// ✅ 2. EDICIÓN DE PRODUCTOS EN INVENTARIO
export function editarProducto(inventario, productoEditado) {
  return inventario.map(p => p.id === productoEditado.id ? { ...p, ...productoEditado } : p);
}

// ✅ 3. REGISTRO DE FOTOGRAFÍA DEL PRODUCTO
// En el formulario de nuevo producto, usar este input:
// <input type="file" accept="image/*" onChange={(e) => manejarFoto(e)} />

export function manejarFoto(evento, setFotoBase64) {
  const archivo = evento.target.files[0];
  const lector = new FileReader();
  lector.onloadend = () => {
    setFotoBase64(lector.result); // imagen base64
  };
  if (archivo) lector.readAsDataURL(archivo);
}

// ✅ 4. FIX BUG TECLADO: se recomienda mantener el formulario abierto mientras se escribe
// Asegúrate que los estados no cambien el foco al escribir y no cierres el modal en onChange
// (no requiere código adicional si se usa correctamente el state del formulario y no se desmonta)

// ✅ 5. SISTEMA DE FIADOS
export function agregarFiado(listaFiados, nuevoFiado) {
  return [...listaFiados, { ...nuevoFiado, id: Date.now(), pagado: false }];
}

export function marcarFiadoComoPagado(listaFiados, id) {
  return listaFiados.map(f => f.id === id ? { ...f, pagado: true } : f);
}

// ✅ 6. FONDO CON DISEÑO CULTURAL MEXICANO
// En tu CSS global:
// body {
//   background-image: url('/imagenes/papel-picado.svg');
//   background-size: cover;
//   background-repeat: no-repeat;
//   background-attachment: fixed;
//   background-position: center;
//   opacity: 0.05;
// }

// ✅ 7. CALENDARIO CON HISTORIAL
// Usar una librería como "react-calendar" para ver los datos por fecha
// Luego mostrar detalles de ventas/resumen al seleccionar el día

// Ejemplo de estructura:
// { fecha: "13/06/2025", ventas: [...], resumen: { ... } }

// ✅ 8. SISTEMA GRATUITO VS PREMIUM
export function esPremium(usuario) {
  return usuario?.plan === 'premium';
}

export function filtrarHistoricoPorPlan(historico, usuario) {
  const diasPermitidos = esPremium(usuario) ? 90 : 15;
  return historico.slice(0, diasPermitidos);
}

// Mostrar distintivos visuales:
// - Gratuito: botón "Actualizar a Premium"
// - Premium: insignia ⭐ y funciones desbloqueadas
