<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreFlow</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P34TJT8XE1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        // Tu ID de Google Analytics configurado
        gtag('config', 'G-P34TJT8XE1', {
            // Configuraciones de privacidad
            anonymize_ip: true,
            allow_google_signals: false,
            allow_ad_personalization_signals: false
        });
        
        // Funci√≥n para trackear eventos personalizados
        function trackEvent(eventName, parameters = {}) {
            try {
                if (window.navigator.onLine) {
                    gtag('event', eventName, {
                        event_category: 'storeflow_action',
                        event_label: eventName,
                        ...parameters
                    });
                }
            } catch (e) {
                console.log('Analytics offline:', eventName);
            }
        }
        
        // Trackear primera visita
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si es primera visita
            const isFirstVisit = !localStorage.getItem('storeflow_visited');
            if (isFirstVisit) {
                localStorage.setItem('storeflow_visited', 'true');
                trackEvent('primera_visita', {
                    custom_parameter: 'nuevo_usuario'
                });
            }
            
            // Trackear carga de la app
            trackEvent('app_cargada', {
                timestamp: new Date().toISOString()
            });
        });
    </script>
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; background: #f3f4f6; }
        .navbar { background: #2563eb; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .container { padding: 16px; padding-bottom: 80px; }
        .card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 4px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 12px; }
        .sale-item, .product-item { background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .hide { display: none; }

        /* ========================================= */
        /* SISTEMA DE NOTIFICACIONES PERSONALIZADAS */
        /* ========================================= */
        
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-left: 4px solid #10b981;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 350px;
            min-width: 280px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.info { border-left-color: #3b82f6; }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover { color: #374151; }
        
        .notification-message {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Modal personalizado para confirmaciones */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        .custom-modal.active { display: flex; }
        
        .custom-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }
        
        .custom-modal.active .custom-modal-content { transform: scale(1); }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
        }
        
        .modal-message {
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .modal-btn-primary {
            background: #10b981;
            color: white;
        }
        
        .modal-btn-primary:hover { background: #059669; }
        
        .modal-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-btn-secondary:hover { background: #d1d5db; }
        
        .modal-btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .modal-btn-danger:hover { background: #dc2626; }

        /* Sistema de apoyo */
        .support-banner {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .support-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .support-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="hearts" width="30" height="30" patternUnits="userSpaceOnUse"><text x="15" y="20" text-anchor="middle" fill="rgba(255,255,255,0.1)" font-size="16">üíù</text></pattern></defs><rect width="100" height="100" fill="url(%23hearts)"/></svg>') repeat;
        }

        .support-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .support-icon {
            font-size: 1.5rem;
        }

        .support-text {
            flex: 1;
        }

        .support-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .support-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .support-cta {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-decoration: none;
        }

        .support-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10003;
            align-items: center;
            justify-content: center;
        }

        .support-modal.active {
            display: flex;
        }

        .support-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        .support-modal.active .support-modal-content {
            transform: scale(1);
        }

        .support-modal-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .support-modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .support-modal-message {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 14px;
        }

        .support-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .support-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .support-modal-btn-primary {
            background: #10b981;
            color: white;
        }

        .support-modal-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .support-modal-btn-close {
            background: #e5e7eb;
            color: #374151;
        }

        .support-modal-btn:hover {
            transform: translateY(-1px);
        }

        /* Responsive para m√≥viles */
        @media (max-width: 480px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            
            .notification {
                transform: translateY(-100px);
                min-width: auto;
                max-width: none;
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor para notificaciones -->
    <div id="notificationContainer" class="notification-container">    </div>
    
    <!-- Modal personalizado para confirmaciones -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <span id="modalIcon" class="modal-icon">‚úÖ</span>
            <h3 id="modalTitle" class="modal-title">Operaci√≥n Exitosa</h3>
            <p id="modalMessage" class="modal-message">Tu operaci√≥n se complet√≥ correctamente.</p>
            <div class="modal-buttons">
                <button id="modalPrimary" class="modal-btn modal-btn-primary" onclick="closeCustomModal()">Entendido</button>
                <button id="modalSecondary" class="modal-btn modal-btn-secondary" onclick="closeCustomModal()" style="display: none;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de apoyo al proyecto -->
    <div id="supportModal" class="support-modal">
        <div class="support-modal-content">
            <div class="support-modal-icon">üè™üíù</div>
            <h3 class="support-modal-title">¬°Apoya el Proyecto StoreFlow!</h3>
            <p class="support-modal-message">
                <strong>StoreFlow es y seguir√° siendo 100% gratuito.</strong><br><br>
                
                Si quieres apoyar el desarrollo y tienes una tienda f√≠sica, considera nuestra lona profesional personalizada. 
                
                <br><br><strong>Es completamente opcional.</strong> Puedes seguir usando StoreFlow sin comprar nada.
            </p>
            <div class="support-modal-buttons">
                <a href="http://articulo.mercadolibre.com.mx/MLM-2349224933-lona-publicitaria-tienda-abarrotes-diseno-premium-precios-_JM" 
                   class="support-modal-btn support-modal-btn-primary" 
                   target="_blank" 
                   onclick="trackSupportAction('mercado_libre_from_app')">
                    üõí Ver Lona
                </a>
                <a href="https://wa.me/525564290144?text=Hola%2C%20vi%20StoreFlow%20y%20me%20interesa%20la%20lona%20para%20mi%20tienda" 
                   class="support-modal-btn support-modal-btn-secondary" 
                   target="_blank" 
                   onclick="trackSupportAction('whatsapp_from_app')">
                    üí¨ WhatsApp
                </a>
                <button class="support-modal-btn support-modal-btn-close" onclick="closeSupportModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div class="navbar" id="navbar"></div>
    
    <div class="container">
        <!-- Vista Principal -->
        <div id="mainView">
            <div class="card" style="text-align: center;">
                <h1 style="font-size: 24px; margin: 0 0 8px 0;">üè™ StoreFlow</h1>
                <p style="color: #6b7280; margin: 0;">Que tengas un excelente d√≠a de ventas, no te rindas</p>
            </div>
            
            <div class="grid-2" style="margin-bottom: 16px;">
                <button class="btn btn-success" onclick="showView('sales')" style="padding: 30px;">
                    <div style="font-size: 32px;">üí∞</div>
                    <div>Registrar Venta</div>
                </button>
                <button class="btn btn-primary" onclick="showView('inventory')" style="padding: 30px;">
                    <div style="font-size: 32px;">üì¶</div>
                    <div>Ver Inventario</div>
                </button>
            </div>
            
            <div class="card">
                <h2 style="font-size: 18px; margin: 0 0 12px 0;">üìä Resumen del D√≠a</h2>
                <div class="flex-between"><span>Ventas:</span><strong>$<span id="totalSales">0.00</span></strong></div>
                <div class="flex-between"><span>Ganancias:</span><strong class="text-success">$<span id="totalProfit">0.00</span></strong></div>
                <div class="flex-between"><span>Productos:</span><strong id="totalProducts">0</strong></div>
            </div>
            
            <div class="card">
                <h2 style="font-size: 18px; margin: 0 0 12px 0;">üßÆ Calculadora</h2>
                <form onsubmit="return false;">
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 8px;">
                        <input type="number" id="calcCost" placeholder="Costo" class="form-input" oninput="calculate()">
                        <input type="number" id="calcPrice" placeholder="Precio" class="form-input" oninput="calculate()">
                        <input type="number" id="calcQty" placeholder="Cant" value="1" class="form-input" oninput="calculate()">
                    </div>
                </form>
                <div id="calcResult" class="hide" style="background: #f3f4f6; padding: 8px; border-radius: 6px; text-align: center;">
                    <strong>Margen: <span id="calcMargin">0</span>%</strong> | 
                    <strong class="text-success">Ganancia: $<span id="calcProfit">0.00</span></strong>
                </div>
            </div>
            
            <button class="btn" onclick="enviarFeedback()" style="margin-top: 16px; background: #25D366; color: white;">
                üí¨ Enviar Comentarios por WhatsApp
            </button>
            
            <!-- Banner de apoyo discreto -->
            <div id="supportBanner" class="support-banner" onclick="showSupportModal()">
                <div class="support-content">
                    <div class="support-icon">üíù</div>
                    <div class="support-text">
                        <div class="support-title">¬øTe gusta StoreFlow? ¬°Ap√≥yanos!</div>
                        <div class="support-subtitle">Opcional ‚Ä¢ La versi√≥n actual seguir√° siendo gratis</div>
                    </div>
                    <div class="support-cta">Ver c√≥mo</div>
                </div>
            </div>
        </div>
        
        <!-- Vista de Ventas -->
        <div id="salesView" class="hide">
            <h1 style="font-size: 20px; margin: 0 0 16px 0;">üí∞ Registrar Venta</h1>
            
            <div class="card">
                <form id="saleForm" onsubmit="registerSale(event)">
                    <div class="form-group">
                        <label class="form-label">Producto:</label>
                        <select id="saleProduct" class="form-input" onchange="updateSaleTotal()" required>
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cantidad:</label>
                        <div class="grid-2" style="grid-template-columns: auto 1fr auto;">
                            <button type="button" class="btn btn-danger" onclick="changeSaleQty(-1)">-</button>
                            <input type="number" id="saleQty" value="1" min="1" class="form-input" style="text-align: center;" oninput="updateSaleTotal()">
                            <button type="button" class="btn btn-success" onclick="changeSaleQty(1)">+</button>
                        </div>
                    </div>
                    
                    <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <strong style="font-size: 20px;">Total: $<span id="saleTotal">0.00</span></strong>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Registrar Venta</button>
                </form>
            </div>
            
            <div class="card">
                <h2 style="font-size: 16px; margin: 0 0 12px 0;">Ventas de Hoy</h2>
                <div id="salesList"></div>
                <button class="btn" onclick="capturarVentas()" style="margin-top: 12px; background: #8b5cf6; color: white; font-size: 14px;">
                    üì∏ Capturar Ventas del D√≠a
                </button>
            </div>
        </div>
        
        <!-- Vista de Inventario -->
        <div id="inventoryView" class="hide">
            <div class="flex-between" style="margin-bottom: 16px;">
                <h1 style="font-size: 20px; margin: 0;">üì¶ Inventario</h1>
                <button class="btn btn-primary" onclick="showProductModal()" style="width: auto; padding: 8px 16px;">+ Nuevo</button>
            </div>
            
            <p style="color: #6b7280; margin: 0 0 12px 0;">Productos: <span id="productCount">0</span>/50</p>
            
            <!-- Botones de Backup -->
            <div class="card" style="background: #fef3c7; border: 1px solid #fbbf24;">
                <h3 style="font-size: 14px; margin: 0 0 6px 0;">üíæ Backup de Inventario</h3>
                <div class="grid-2" style="gap: 6px;">
                    <button class="btn btn-secondary" onclick="exportarInventario()" style="background: #059669; padding: 8px 12px; font-size: 14px;">
                        üìã Copiar Inventario
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarImportDialog()" style="background: #dc2626; padding: 8px 12px; font-size: 14px;">
                        üì• Restaurar Inventario
                    </button>
                </div>
                <p style="font-size: 11px; color: #78716c; margin: 6px 0 0 0;">
                    Usa estos botones antes de actualizar la app
                </p>
            </div>
            
            <div id="inventoryList"></div>
        </div>
    </div>
    
    <!-- Modal de Producto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin: 0 0 16px 0;">Nuevo Producto</h2>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label class="form-label">Nombre:</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stock:</label>
                    <input type="number" id="productStock" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Costo:</label>
                    <input type="number" id="productCost" step="0.01" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio:</label>
                    <input type="number" id="productPrice" step="0.01" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Vencimiento:</label>
                    <input type="date" id="productExpiry" class="form-input" required>
                </div>
                
                <div class="grid-2">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="hideProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Navegaci√≥n inferior -->
    <div id="bottomNav" class="bottom-nav hide">
        <button class="btn btn-primary" onclick="showView('main')">üè† Inicio</button>
    </div>
    
    <script>
        // =========================================================================
        // SISTEMA DE NOTIFICACIONES PERSONALIZADAS
        // =========================================================================
        
        // Funci√≥n para mostrar notificaciones tipo toast
        function showNotification(type, title, message, duration = 4000) {
            const container = document.getElementById('notificationContainer');
            
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Iconos por tipo
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        ${icons[type]} ${title}
                    </div>
                    <button class="notification-close" onclick="closeNotification(this)">√ó</button>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            // Agregar al contenedor
            container.appendChild(notification);
            
            // Mostrar con animaci√≥n
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-ocultar despu√©s del tiempo especificado
            setTimeout(() => {
                if (notification.parentElement) {
                    closeNotification(notification.querySelector('.notification-close'));
                }
            }, duration);
        }
        
        // Cerrar notificaci√≥n individual
        function closeNotification(closeBtn) {
            const notification = closeBtn.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
        
        // Funci√≥n para mostrar modales de confirmaci√≥n
        function showCustomModal(icon, title, message, primaryText = 'Entendido', secondaryText = null, onPrimary = null, onSecondary = null) {
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalPrimary = document.getElementById('modalPrimary');
            const modalSecondary = document.getElementById('modalSecondary');
            
            // Configurar contenido
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalPrimary.textContent = primaryText;
            
            // Configurar bot√≥n secundario
            if (secondaryText) {
                modalSecondary.textContent = secondaryText;
                modalSecondary.style.display = 'block';
            } else {
                modalSecondary.style.display = 'none';
            }
            
            // Configurar callbacks
            modalPrimary.onclick = () => {
                if (onPrimary) onPrimary();
                closeCustomModal();
            };
            
            if (onSecondary) {
                modalSecondary.onclick = () => {
                    onSecondary();
                    closeCustomModal();
                };
            }
            
            // Mostrar modal
            modal.classList.add('active');
        }
        
        function closeCustomModal() {
            document.getElementById('customModal').classList.remove('active');
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('customModal').addEventListener('click', (e) => {
            if (e.target.id === 'customModal') {
                closeCustomModal();
            }
        });

        // =========================================================================
        // APLICACI√ìN STOREFLOW CON MENSAJES PERSONALIZADOS
        // =========================================================================
        
        // Estado de la aplicaci√≥n
        let state = {
            inventory: [],
            sales: [],
            currentView: 'main'
        };
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDate();
            updateSummary();
            renderInventory();
            renderSales();
            setInterval(checkMidnight, 60000);
        });
        
        // Funciones de almacenamiento
        function loadData() {
            try {
                // Cargar inventario
                const savedInventory = localStorage.getItem('tiendita_inventory');
                if (savedInventory) {
                    state.inventory = JSON.parse(savedInventory);
                    trackEvent('inventario_cargado', {
                        productos_count: state.inventory.length
                    });
                } else {
                    // Datos iniciales
                    state.inventory = [
                        { id: 1, name: 'Coca-Cola 600ml', stock: 24, cost: 12, price: 18, expiry: '2025-08-15' },
                        { id: 2, name: 'Sabritas Original', stock: 15, cost: 8, price: 15, expiry: '2025-07-20' },
                        { id: 3, name: 'Pan Bimbo Grande', stock: 8, cost: 25, price: 35, expiry: '2025-06-25' },
                        { id: 4, name: 'Leche Lala 1L', stock: 12, cost: 18, price: 25, expiry: '2025-06-20' },
                        { id: 5, name: 'Huevos San Juan', stock: 30, cost: 35, price: 50, expiry: '2025-07-01' }
                    ];
                    saveInventory();
                    showNotification('info', 'Bienvenido a StoreFlow', 
                        'Hemos cargado productos de ejemplo para que puedas probar la aplicaci√≥n');
                    trackEvent('productos_ejemplo_cargados', {
                        productos_count: state.inventory.length
                    });
                }
                
                // Cargar ventas del d√≠a
                const today = new Date().toDateString();
                const savedSales = localStorage.getItem('tiendita_sales_' + today);
                if (savedSales) {
                    state.sales = JSON.parse(savedSales);
                    trackEvent('ventas_dia_cargadas', {
                        ventas_count: state.sales.length
                    });
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
                showNotification('error', 'Error de Carga', 
                    'Hubo un problema cargando tus datos. Se inicializar√° con productos de ejemplo.');
                trackEvent('error_carga_datos', {
                    error_message: e.message
                });
            }
        }
        
        function saveInventory() {
            try {
                localStorage.setItem('tiendita_inventory', JSON.stringify(state.inventory));
                trackEvent('inventario_guardado', {
                    productos_count: state.inventory.length
                });
            } catch (e) {
                console.error('Error guardando inventario:', e);
                showNotification('error', 'Error de Guardado', 
                    'No se pudo guardar el inventario. Verifica el espacio de almacenamiento.');
                trackEvent('error_guardar_inventario', {
                    error_message: e.message
                });
            }
        }
        
        function saveSales() {
            try {
                const today = new Date().toDateString();
                localStorage.setItem('tiendita_sales_' + today, JSON.stringify(state.sales));
                trackEvent('ventas_guardadas', {
                    ventas_count: state.sales.length
                });
            } catch (e) {
                console.error('Error guardando ventas:', e);
                showNotification('error', 'Error de Guardado', 
                    'No se pudieron guardar las ventas del d√≠a.');
                trackEvent('error_guardar_ventas', {
                    error_message: e.message
                });
            }
        }
        
        // Funciones de UI
        function showView(view) {
            document.getElementById('mainView').classList.toggle('hide', view !== 'main');
            document.getElementById('salesView').classList.toggle('hide', view !== 'sales');
            document.getElementById('inventoryView').classList.toggle('hide', view !== 'inventory');
            document.getElementById('bottomNav').classList.toggle('hide', view === 'main');
            
            state.currentView = view;
            
            trackEvent('vista_navegada', {
                vista_destino: view
            });
            
            if (view === 'sales') {
                updateSaleProductList();
                trackEvent('vista_ventas_abierta');
            } else if (view === 'inventory') {
                trackEvent('vista_inventario_abierta');
            }
        }
        
        function updateDate() {
            const date = new Date().toLocaleDateString('es-MX', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            });
            document.getElementById('navbar').textContent = date;
        }
        
        function updateSummary() {
            const summary = state.sales.reduce((acc, sale) => {
                acc.totalSales += sale.total;
                acc.totalProfit += (sale.total - (sale.cost * sale.quantity));
                acc.totalProducts += sale.quantity;
                return acc;
            }, { totalSales: 0, totalProfit: 0, totalProducts: 0 });
            
            document.getElementById('totalSales').textContent = summary.totalSales.toFixed(2);
            document.getElementById('totalProfit').textContent = summary.totalProfit.toFixed(2);
            document.getElementById('totalProducts').textContent = summary.totalProducts;
        }
        
        // Calculadora
        function calculate() {
            const cost = parseFloat(document.getElementById('calcCost').value) || 0;
            const price = parseFloat(document.getElementById('calcPrice').value) || 0;
            const qty = parseInt(document.getElementById('calcQty').value) || 1;
            
            if (cost > 0 && price > 0) {
                const margin = ((price - cost) / cost) * 100;
                const profit = (price - cost) * qty;
                
                document.getElementById('calcMargin').textContent = margin.toFixed(1);
                document.getElementById('calcProfit').textContent = profit.toFixed(2);
                document.getElementById('calcResult').classList.remove('hide');
                
                trackEvent('calculadora_usada', {
                    margen_calculado: margin.toFixed(1),
                    ganancia_calculada: profit.toFixed(2)
                });
            } else {
                document.getElementById('calcResult').classList.add('hide');
            }
        }
        
        // Ventas
        function updateSaleProductList() {
            const select = document.getElementById('saleProduct');
            select.innerHTML = '<option value="">Selecciona...</option>';
            
            state.inventory
                .filter(p => p.stock > 0)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ${product.price} (${product.stock})`;
                    select.appendChild(option);
                });
        }
        
        function updateSaleTotal() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQty').value) || 0;
            
            if (productId) {
                const product = state.inventory.find(p => p.id === productId);
                if (product) {
                    const total = product.price * quantity;
                    document.getElementById('saleTotal').textContent = total.toFixed(2);
                }
            } else {
                document.getElementById('saleTotal').textContent = '0.00';
            }
        }
        
        function changeSaleQty(delta) {
            const input = document.getElementById('saleQty');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
            updateSaleTotal();
        }
        
        function registerSale(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQty').value);
            
            const product = state.inventory.find(p => p.id === productId);
            if (!product) return;
            
            if (product.stock < quantity) {
                showNotification('error', 'Stock Insuficiente', 
                    `Solo quedan ${product.stock} unidades de ${product.name}`);
                trackEvent('error_stock_insuficiente', {
                    producto_id: productId,
                    stock_disponible: product.stock,
                    cantidad_solicitada: quantity
                });
                return;
            }
            
            const sale = {
                id: Date.now(),
                productName: product.name,
                quantity: quantity,
                price: product.price,
                cost: product.cost,
                total: product.price * quantity,
                time: new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })
            };
            
            state.sales.push(sale);
            product.stock -= quantity;
            
            saveInventory();
            saveSales();
            updateSummary();
            renderSales();
            
            // Mostrar notificaci√≥n de √©xito personalizada
            const ganancia = (sale.price - sale.cost) * quantity;
            showNotification('success', 'Venta Registrada', 
                `${quantity} ${product.name} por ${sale.total.toFixed(2)} (Ganancia: ${ganancia.toFixed(2)})`);
            
            trackEvent('venta_registrada', {
                producto_nombre: product.name,
                cantidad: quantity,
                total_venta: sale.total.toFixed(2),
                ganancia: ganancia.toFixed(2)
            });
            
            // Limpiar formulario
            document.getElementById('saleForm').reset();
            document.getElementById('saleQty').value = 1;
            updateSaleTotal();
            updateSaleProductList();
            
            // Verificar stock bajo
            if (product.stock <= 5 && product.stock > 0) {
                setTimeout(() => {
                    showNotification('warning', 'Stock Bajo', 
                        `Quedan solo ${product.stock} unidades de ${product.name}`);
                }, 1000);
            } else if (product.stock === 0) {
                setTimeout(() => {
                    showNotification('error', 'Producto Agotado', 
                        `${product.name} se ha agotado completamente`);
                }, 1000);
            }
            
            // Mostrar apoyo despu√©s de ciertos √©xitos
            showSupportAfterSuccess();
        }
        
        function renderSales() {
            const container = document.getElementById('salesList');
            
            if (state.sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Sin ventas</p>';
                return;
            }
            
            container.innerHTML = state.sales.map(sale => `
                <div class="sale-item">
                    <div class="flex-between">
                        <strong>${sale.productName}</strong>
                        <span>${sale.total.toFixed(2)}</span>
                    </div>
                    <div style="font-size: 12px; color: #6b7280;">
                        ${sale.quantity} unidades ‚Ä¢ ${sale.time}
                    </div>
                </div>
            `).join('');
        }
        
        // Inventario
        function renderInventory() {
            const container = document.getElementById('inventoryList');
            document.getElementById('productCount').textContent = state.inventory.length;
            
            if (state.inventory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Sin productos</p>';
                return;
            }
            
            // Ordenar alfab√©ticamente por nombre
            const sortedInventory = [...state.inventory].sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = sortedInventory.map(product => `
                <div class="product-item">
                    <div class="flex-between">
                        <strong>${product.name}</strong>
                        <div>
                            <button onclick="editProduct(${product.id})" style="background: none; border: none; font-size: 18px; cursor: pointer;">‚úèÔ∏è</button>
                            <button onclick="deleteProduct(${product.id})" style="background: none; border: none; font-size: 18px; cursor: pointer;">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size: 14px;">
                        <div>Stock: ${product.stock} | Precio: ${product.price}</div>
                        <div>Costo: ${product.cost} | Vence: ${new Date(product.expiry).toLocaleDateString('es-MX')}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function showProductModal(product = null) {
            if (product) {
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCost').value = product.cost;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productExpiry').value = product.expiry;
                
                trackEvent('modal_editar_producto_abierto', {
                    producto_id: product.id,
                    producto_nombre: product.name
                });
            } else {
                document.getElementById('modalTitle').textContent = 'Nuevo Producto';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                
                trackEvent('modal_nuevo_producto_abierto');
            }
            
            document.getElementById('productModal').classList.add('active');
        }
        
        function hideProductModal() {
            document.getElementById('productModal').classList.remove('active');
            trackEvent('modal_producto_cerrado');
        }
        
        function editProduct(id) {
            const product = state.inventory.find(p => p.id === id);
            if (product) {
                showProductModal(product);
            }
        }
        
        function deleteProduct(id) {
            const product = state.inventory.find(p => p.id === id);
            if (!product) return;
            
            showCustomModal(
                'üóëÔ∏è',
                'Eliminar Producto',
                `¬øEst√°s seguro de eliminar "${product.name}"? Esta acci√≥n no se puede deshacer.`,
                'Eliminar',
                'Cancelar',
                () => {
                    // Confirmar eliminaci√≥n
                    state.inventory = state.inventory.filter(p => p.id !== id);
                    saveInventory();
                    renderInventory();
                    updateSaleProductList();
                    
                    showNotification('success', 'Producto Eliminado', 
                        `${product.name} ha sido eliminado del inventario`);
                    
                    trackEvent('producto_eliminado', {
                        producto_id: id,
                        producto_nombre: product.name
                    });
                },
                () => {
                    // Cancelar
                    trackEvent('eliminacion_producto_cancelada', {
                        producto_id: id
                    });
                }
            );
        }
        
        function saveProduct(event) {
            event.preventDefault();
            
            const id = document.getElementById('productId').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('productName').value.trim(),
                stock: parseInt(document.getElementById('productStock').value),
                cost: parseFloat(document.getElementById('productCost').value),
                price: parseFloat(document.getElementById('productPrice').value),
                expiry: document.getElementById('productExpiry').value
            };
            
            // Validaciones
            if (product.price <= product.cost) {
                showNotification('warning', 'Precio Incorrecto', 
                    'El precio de venta debe ser mayor al costo');
                return;
            }
            
            if (id) {
                // Editar
                const index = state.inventory.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    state.inventory[index] = product;
                    showNotification('success', 'Producto Actualizado', 
                        `${product.name} ha sido actualizado correctamente`);
                    trackEvent('producto_editado', {
                        producto_id: product.id,
                        producto_nombre: product.name
                    });
                }
            } else {
                // Nuevo
                if (state.inventory.length >= 50) {
                    showNotification('error', 'L√≠mite Alcanzado', 
                        'M√°ximo 50 productos. Elimina algunos productos para agregar nuevos.');
                    trackEvent('limite_productos_alcanzado', {
                        productos_actuales: state.inventory.length
                    });
                    return;
                }
                state.inventory.push(product);
                showNotification('success', 'Producto Agregado', 
                    `${product.name} se agreg√≥ al inventario`);
                trackEvent('producto_agregado', {
                    producto_id: product.id,
                    producto_nombre: product.name,
                    total_productos: state.inventory.length
                });
            }
            
            saveInventory();
            renderInventory();
            updateSaleProductList();
            hideProductModal();
        }
        
        // Verificar medianoche
        function checkMidnight() {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                const ventasAyer = state.sales.length;
                state.sales = [];
                saveSales();
                updateSummary();
                renderSales();
                
                if (ventasAyer > 0) {
                    showNotification('info', 'Nuevo D√≠a', 
                        `Registraste ${ventasAyer} ventas ayer. ¬°Que tengas un excelente d√≠a de ventas!`);
                }
                trackEvent('nuevo_dia_iniciado', {
                    ventas_dia_anterior: ventasAyer
                });
            }
        }
        
        // Funciones de Backup
        function exportarInventario() {
            if (state.inventory.length === 0) {
                showNotification('warning', 'Sin Productos', 
                    'No hay productos para exportar');
                trackEvent('backup_sin_productos');
                return;
            }
            
            const backup = {
                version: '1.0',
                fecha: new Date().toLocaleString('es-MX'),
                totalProductos: state.inventory.length,
                productos: state.inventory
            };
            
            const textoBackup = JSON.stringify(backup);
            
            // Intentar copiar al portapapeles
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textoBackup).then(() => {
                    showNotification('success', 'Backup Completado', 
                        `${state.inventory.length} productos copiados al portapapeles. Gu√°rdalo en WhatsApp o Notas.`);
                    trackEvent('backup_exportado_exitoso', {
                        productos_count: state.inventory.length,
                        metodo: 'clipboard'
                    });
                }).catch(() => {
                    // Fallback si falla el portapapeles
                    mostrarTextoParaCopiar(textoBackup);
                });
            } else {
                // Fallback para navegadores sin soporte
                mostrarTextoParaCopiar(textoBackup);
            }
        }
        
        function mostrarTextoParaCopiar(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showNotification('success', 'Backup Completado', 
                    'Inventario copiado. P√©galo en un lugar seguro.');
                trackEvent('backup_exportado_exitoso', {
                    productos_count: state.inventory.length,
                    metodo: 'execCommand'
                });
            } catch (err) {
                showCustomModal('üìã', 'Copiar Manualmente', 
                    'Copia este texto y gu√°rdalo en un lugar seguro:', 'Cerrar');
                // Mostrar el texto en el modal
                document.getElementById('modalMessage').innerHTML = 
                    `<textarea style="width:100%;height:100px;font-size:12px;" readonly>${texto}</textarea>`;
                trackEvent('backup_exportado_manual', {
                    productos_count: state.inventory.length
                });
            }
            
            document.body.removeChild(textarea);
        }
        
        function mostrarImportDialog() {
            showCustomModal(
                'üì•',
                'Restaurar Inventario',
                'Pega aqu√≠ el texto de tu inventario guardado:',
                'Restaurar',
                'Cancelar',
                () => {
                    // Crear un prompt personalizado usando el modal
                    const modalMessage = document.getElementById('modalMessage');
                    modalMessage.innerHTML = `
                        <textarea id="backupText" placeholder="Pega el texto del backup aqu√≠..." style="width:100%;height:100px;font-size:12px;margin:10px 0;"></textarea>
                    `;
                    
                    const modalPrimary = document.getElementById('modalPrimary');
                    modalPrimary.textContent = 'Procesar';
                    modalPrimary.onclick = () => {
                        const textoBackup = document.getElementById('backupText').value;
                        procesarImport(textoBackup);
                    };
                },
                () => {
                    trackEvent('backup_import_cancelado');
                }
            );
        }
        
        function procesarImport(textoBackup) {
            if (!textoBackup.trim()) {
                showNotification('warning', 'Texto Vac√≠o', 
                    'Por favor pega el texto del backup');
                trackEvent('backup_import_cancelado');
                return;
            }
            
            try {
                const backup = JSON.parse(textoBackup);
                
                if (!backup.productos || !Array.isArray(backup.productos)) {
                    throw new Error('Formato inv√°lido');
                }
                
                showCustomModal(
                    '‚ö†Ô∏è',
                    'Confirmar Restauraci√≥n',
                    `¬øRestaurar inventario?\n\nFecha: ${backup.fecha || 'Desconocida'}\nProductos: ${backup.productos.length}\n\n‚ö†Ô∏è Esto REEMPLAZAR√Å tu inventario actual`,
                    'Restaurar',
                    'Cancelar',
                    () => {
                        const productosAntes = state.inventory.length;
                        state.inventory = backup.productos;
                        saveInventory();
                        renderInventory();
                        updateSaleProductList();
                        
                        showNotification('success', 'Inventario Restaurado', 
                            `${backup.productos.length} productos cargados correctamente`);
                        
                        trackEvent('backup_importado_exitoso', {
                            productos_antes: productosAntes,
                            productos_despues: backup.productos.length,
                            fecha_backup: backup.fecha
                        });
                        
                        closeCustomModal();
                    },
                    () => {
                        trackEvent('backup_import_cancelado_confirmacion');
                        closeCustomModal();
                    }
                );
                
            } catch (error) {
                showNotification('error', 'Backup Inv√°lido', 
                    'El texto no es v√°lido. Aseg√∫rate de copiar TODO el texto del backup.');
                trackEvent('backup_import_error', {
                    error_message: error.message
                });
                closeCustomModal();
            }
        }
        
        // Funci√≥n de Feedback por WhatsApp
        function enviarFeedback() {
            // Calcular d√≠as de uso
            const diasUso = calcularDiasUso();
            
            // Recopilar estad√≠sticas
            const ventasHoy = state.sales.length;
            const totalVentasHoy = state.sales.reduce((sum, s) => sum + s.total, 0);
            const totalProductos = state.inventory.length;
            
            // Crear mensaje
            const mensaje = `üè™ *Feedback StoreFlow*\n\n` +
                `üìä *Mis estad√≠sticas:*\n` +
                `‚Ä¢ D√≠as usando la app: ${diasUso}\n` +
                `‚Ä¢ Productos en inventario: ${totalProductos}\n` +
                `‚Ä¢ Ventas registradas hoy: ${ventasHoy}\n` +
                `‚Ä¢ Total vendido hoy: ${totalVentasHoy.toFixed(2)}\n\n` +
                `üí≠ *Mi experiencia:*\n` +
                `(Escribe aqu√≠ qu√© te gusta, qu√© mejorar√≠as o cualquier comentario)\n\n` +
                `‚≠ê *Calificaci√≥n:* _/5`;
            
            // Tu n√∫mero de WhatsApp (cambia esto por tu n√∫mero real)
            const numeroWhatsApp = '525564290144'; // Formato: c√≥digo pa√≠s + n√∫mero
            
            // Crear URL de WhatsApp
            const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
            
            // Trackear env√≠o de feedback
            trackEvent('feedback_whatsapp_enviado', {
                dias_uso: diasUso,
                productos_inventario: totalProductos,
                ventas_hoy: ventasHoy,
                total_ventas_hoy: totalVentasHoy.toFixed(2)
            });
            
            // Mostrar confirmaci√≥n antes de abrir WhatsApp
            showCustomModal(
                'üì±',
                'Abrir WhatsApp',
                'Se abrir√° WhatsApp con un mensaje prellenado con tus estad√≠sticas. ¬øContinuar?',
                'Abrir WhatsApp',
                'Cancelar',
                () => {
                    window.open(url, '_blank');
                    showNotification('success', 'WhatsApp Abierto', 
                        'Gracias por ayudarnos a mejorar StoreFlow');
                }
            );
        }
        
        function calcularDiasUso() {
            let primerUso = localStorage.getItem('tiendita_primer_uso');
            
            if (!primerUso) {
                // Primera vez que usa la app
                primerUso = new Date().toISOString();
                localStorage.setItem('tiendita_primer_uso', primerUso);
                trackEvent('primer_uso_registrado');
                return 1;
            }
            
            // Calcular d√≠as transcurridos
            const fechaInicio = new Date(primerUso);
            const fechaHoy = new Date();
            const diferencia = fechaHoy - fechaInicio;
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24)) + 1;
            
            return dias;
        }
        
        // Funci√≥n para capturar ventas del d√≠a
        function capturarVentas() {
            // Trackear uso de captura
            trackEvent('captura_ventas_iniciada', {
                ventas_count: state.sales.length
            });
            
            // Crear un canvas temporal para la captura
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar tama√±o del canvas (tama√±o de pantalla m√≥vil)
            canvas.width = 400;
            canvas.height = 600;
            
            // Fondo blanco
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Configurar fuente
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            
            // T√≠tulo principal
            ctx.fillText('StoreFlow', canvas.width / 2, 40);
            
            // Fecha
            const fecha = new Date().toLocaleDateString('es-MX', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6b7280';
            ctx.fillText(fecha, canvas.width / 2, 70);
            
            // L√≠nea separadora
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(30, 90);
            ctx.lineTo(370, 90);
            ctx.stroke();
            
            // Resumen del d√≠a
            ctx.font = 'bold 18px Arial';
            ctx.fillStyle = '#1f2937';
            ctx.textAlign = 'left';
            ctx.fillText('üìä Resumen del D√≠a', 30, 120);
            
            // Calcular totales
            const summary = state.sales.reduce((acc, sale) => {
                acc.totalSales += sale.total;
                acc.totalProfit += (sale.total - (sale.cost * sale.quantity));
                acc.totalProducts += sale.quantity;
                return acc;
            }, { totalSales: 0, totalProfit: 0, totalProducts: 0 });
            
            // Mostrar resumen
            ctx.font = '14px Arial';
            ctx.fillStyle = '#374151';
            let yPos = 150;
            
            ctx.fillText(`üí∞ Total Ventas: ${summary.totalSales.toFixed(2)}`, 40, yPos);
            yPos += 25;
            ctx.fillStyle = '#10b981';
            ctx.fillText(`üíö Ganancias: ${summary.totalProfit.toFixed(2)}`, 40, yPos);
            yPos += 25;
            ctx.fillStyle = '#374151';
            ctx.fillText(`üì¶ Productos vendidos: ${summary.totalProducts}`, 40, yPos);
            yPos += 40;
            
            // Lista de ventas
            if (state.sales.length > 0) {
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#1f2937';
                ctx.fillText('üßæ Detalle de Ventas', 30, yPos);
                yPos += 30;
                
                ctx.font = '12px Arial';
                ctx.fillStyle = '#374151';
                
                state.sales.forEach((sale, index) => {
                    if (yPos > 550) return; // Evitar que se salga del canvas
                    
                    // Nombre del producto y hora
                    ctx.fillText(`${sale.time} - ${sale.productName}`, 40, yPos);
                    yPos += 15;
                    
                    // Cantidad y total
                    ctx.fillStyle = '#6b7280';
                    ctx.fillText(`   ${sale.quantity} unidades √ó ${sale.price} = ${sale.total.toFixed(2)}`, 40, yPos);
                    yPos += 20;
                    
                    ctx.fillStyle = '#374151';
                });
            } else {
                ctx.font = '14px Arial';
                ctx.fillStyle = '#9ca3af';
                ctx.textAlign = 'center';
                ctx.fillText('No hay ventas registradas hoy', canvas.width / 2, yPos);
            }
            
            // Pie de p√°gina
            ctx.font = '12px Arial';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            ctx.fillText('Generado por StoreFlow', canvas.width / 2, canvas.height - 20);
            
            // Convertir canvas a imagen y descargar
            try {
                // Crear enlace de descarga
                const link = document.createElement('a');
                link.download = `ventas_storeflow_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                
                // Simular clic para descargar
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('success', 'Captura Guardada', 
                    'La imagen se descarg√≥ correctamente. B√∫scala en tu carpeta de Descargas.');
                
                trackEvent('captura_ventas_exitosa', {
                    ventas_count: state.sales.length,
                    total_ventas: summary.totalSales.toFixed(2),
                    metodo: 'descarga'
                });
                
            } catch (error) {
                // Fallback: mostrar la imagen en una nueva ventana
                const newWindow = window.open();
                newWindow.document.write(`
                    <html>
                        <head><title>Ventas del D√≠a - StoreFlow</title></head>
                        <body style="margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f3f4f6;">
                            <div style="text-align: center;">
                                <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <p style="margin-top: 20px; color: #6b7280;">Haz clic derecho en la imagen y selecciona "Guardar imagen como..."</p>
                            </div>
                        </body>
                    </html>
                `);
                newWindow.document.close();
                
                showNotification('info', 'Captura Abierta', 
                    'La captura se abri√≥ en una nueva ventana. Haz clic derecho para guardarla.');
                
                trackEvent('captura_ventas_exitosa', {
                    ventas_count: state.sales.length,
                    total_ventas: summary.totalSales.toFixed(2),
                    metodo: 'ventana_nueva'
                });
            }
        }
    </script>
</body>
</html>
