<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreFlow</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-P34TJT8XE1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-P34TJT8XE1', {
            anonymize_ip: true,
            allow_google_signals: false,
            allow_ad_personalization_signals: false
        });
        
        function trackEvent(eventName, parameters = {}) {
            try {
                if (window.navigator.onLine) {
                    gtag('event', eventName, {
                        event_category: 'storeflow_action',
                        event_label: eventName,
                        ...parameters
                    });
                }
            } catch (e) {
                console.log('Analytics offline:', eventName);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const isFirstVisit = !localStorage.getItem('storeflow_visited');
            if (isFirstVisit) {
                localStorage.setItem('storeflow_visited', 'true');
                trackEvent('primera_visita', {
                    custom_parameter: 'nuevo_usuario'
                });
            }
            
            trackEvent('app_cargada', {
                timestamp: new Date().toISOString()
            });
        });
    </script>
    
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 0; background: #f3f4f6; }
        .navbar { background: #2563eb; color: white; padding: 12px; text-align: center; font-weight: bold; }
        .container { padding: 16px; padding-bottom: 80px; }
        .card { background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; width: 100%; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 4px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 12px; }
        .sale-item, .product-item { background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 8px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .text-success { color: #10b981; }
        .text-danger { color: #ef4444; }
        .hide { display: none; }

        /* Sistema de notificaciones */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-left: 4px solid #10b981;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: auto;
            max-width: 350px;
            min-width: 280px;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.info { border-left-color: #3b82f6; }
        
        .notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover { color: #374151; }
        
        .notification-message {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Modal personalizado */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        .custom-modal.active { display: flex; }
        
        .custom-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }
        
        .custom-modal.active .custom-modal-content { transform: scale(1); }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
        }
        
        .modal-message {
            color: #6b7280;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .modal-btn-primary {
            background: #10b981;
            color: white;
        }
        
        .modal-btn-primary:hover { background: #059669; }
        
        .modal-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-btn-secondary:hover { background: #d1d5db; }

        /* Sistema de apoyo */
        .support-banner {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 16px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .support-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .support-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .support-icon {
            font-size: 1.5rem;
        }

        .support-text {
            flex: 1;
        }

        .support-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .support-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .support-cta {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-decoration: none;
        }

        .support-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10003;
            align-items: center;
            justify-content: center;
        }

        .support-modal.active {
            display: flex;
        }

        .support-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        .support-modal.active .support-modal-content {
            transform: scale(1);
        }

        .support-modal-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .support-modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .support-modal-message {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 14px;
        }

        .support-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .support-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .support-modal-btn-primary {
            background: #10b981;
            color: white;
        }

        .support-modal-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .support-modal-btn-close {
            background: #e5e7eb;
            color: #374151;
        }

        .support-modal-btn:hover {
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            
            .notification {
                transform: translateY(-100px);
                min-width: auto;
                max-width: none;
            }
            
            .notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor para notificaciones -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <!-- Modal personalizado -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <span id="modalIcon" class="modal-icon">✅</span>
            <h3 id="modalTitle" class="modal-title">Operación Exitosa</h3>
            <p id="modalMessage" class="modal-message">Tu operación se completó correctamente.</p>
            <div class="modal-buttons">
                <button id="modalPrimary" class="modal-btn modal-btn-primary" onclick="closeCustomModal()">Entendido</button>
                <button id="modalSecondary" class="modal-btn modal-btn-secondary" onclick="closeCustomModal()" style="display: none;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de apoyo -->
    <div id="supportModal" class="support-modal">
        <div class="support-modal-content">
            <div class="support-modal-icon">🏪💝</div>
            <h3 class="support-modal-title">¡Apoya el Proyecto StoreFlow!</h3>
            <p class="support-modal-message">
                <strong>StoreFlow es y seguirá siendo 100% gratuito.</strong><br><br>
                Si quieres apoyar el desarrollo y tienes una tienda física, considera nuestra lona profesional personalizada. 
                <br><br><strong>Es completamente opcional.</strong> Puedes seguir usando StoreFlow sin comprar nada.
            </p>
            <div class="support-modal-buttons">
                <a href="http://articulo.mercadolibre.com.mx/MLM-2349224933-lona-publicitaria-tienda-abarrotes-diseno-premium-precios-_JM" 
                   class="support-modal-btn support-modal-btn-primary" 
                   target="_blank" 
                   onclick="trackSupportAction('mercado_libre_from_app')">
                    🛒 Ver Lona
                </a>
                <a href="https://wa.me/525564290144?text=Hola%2C%20vi%20StoreFlow%20y%20me%20interesa%20la%20lona%20para%20mi%20tienda" 
                   class="support-modal-btn support-modal-btn-secondary" 
                   target="_blank" 
                   onclick="trackSupportAction('whatsapp_from_app')">
                    💬 WhatsApp
                </a>
                <button class="support-modal-btn support-modal-btn-close" onclick="closeSupportModal()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <div class="navbar" id="navbar"></div>
    
    <div class="container">
        <!-- Vista Principal -->
        <div id="mainView">
            <div class="card" style="text-align: center;">
                <h1 style="font-size: 24px; margin: 0 0 8px 0;">🏪 StoreFlow</h1>
                <p style="color: #6b7280; margin: 0;">Que tengas un excelente día de ventas, no te rindas</p>
            </div>
            
            <div class="grid-2" style="margin-bottom: 16px;">
                <button class="btn btn-success" onclick="showView('sales')" style="padding: 30px;">
                    <div style="font-size: 32px;">💰</div>
                    <div>Registrar Venta</div>
                </button>
                <button class="btn btn-primary" onclick="showView('inventory')" style="padding: 30px;">
                    <div style="font-size: 32px;">📦</div>
                    <div>Ver Inventario</div>
                </button>
            </div>
            
            <div class="card">
                <h2 style="font-size: 18px; margin: 0 0 12px 0;">📊 Resumen del Día</h2>
                <div class="flex-between"><span>Ventas:</span><strong>$<span id="totalSales">0.00</span></strong></div>
                <div class="flex-between"><span>Ganancias:</span><strong class="text-success">$<span id="totalProfit">0.00</span></strong></div>
                <div class="flex-between"><span>Productos:</span><strong id="totalProducts">0</strong></div>
            </div>
            
            <div class="card">
                <h2 style="font-size: 18px; margin: 0 0 12px 0;">🧮 Calculadora</h2>
                <form onsubmit="return false;">
                    <div class="grid-2" style="grid-template-columns: 1fr 1fr 1fr; margin-bottom: 8px;">
                        <input type="number" id="calcCost" placeholder="Costo" class="form-input" oninput="calculate()">
                        <input type="number" id="calcPrice" placeholder="Precio" class="form-input" oninput="calculate()">
                        <input type="number" id="calcQty" placeholder="Cant" value="1" class="form-input" oninput="calculate()">
                    </div>
                </form>
                <div id="calcResult" class="hide" style="background: #f3f4f6; padding: 8px; border-radius: 6px; text-align: center;">
                    <strong>Margen: <span id="calcMargin">0</span>%</strong> | 
                    <strong class="text-success">Ganancia: $<span id="calcProfit">0.00</span></strong>
                </div>
            </div>
            
            <button class="btn" onclick="enviarFeedback()" style="margin-top: 16px; background: #25D366; color: white;">
                💬 Enviar Comentarios por WhatsApp
            </button>
            
            <!-- Banner de apoyo -->
            <div id="supportBanner" class="support-banner" onclick="showSupportModal()">
                <div class="support-content">
                    <div class="support-icon">💝</div>
                    <div class="support-text">
                        <div class="support-title">¿Te gusta StoreFlow? ¡Apóyanos!</div>
                        <div class="support-subtitle">Opcional • La versión actual seguirá siendo gratis</div>
                    </div>
                    <div class="support-cta">Ver cómo</div>
                </div>
            </div>
        </div>
        
        <!-- Vista de Ventas -->
        <div id="salesView" class="hide">
            <h1 style="font-size: 20px; margin: 0 0 16px 0;">💰 Registrar Venta</h1>
            
            <div class="card">
                <form id="saleForm" onsubmit="registerSale(event)">
                    <div class="form-group">
                        <label class="form-label">Producto:</label>
                        <select id="saleProduct" class="form-input" onchange="updateSaleTotal()" required>
                            <option value="">Selecciona...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cantidad:</label>
                        <div class="grid-2" style="grid-template-columns: auto 1fr auto;">
                            <button type="button" class="btn btn-danger" onclick="changeSaleQty(-1)">-</button>
                            <input type="number" id="saleQty" value="1" min="1" class="form-input" style="text-align: center;" oninput="updateSaleTotal()">
                            <button type="button" class="btn btn-success" onclick="changeSaleQty(1)">+</button>
                        </div>
                    </div>
                    
                    <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <strong style="font-size: 20px;">Total: $<span id="saleTotal">0.00</span></strong>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Registrar Venta</button>
                </form>
            </div>
            
            <div class="card">
                <h2 style="font-size: 16px; margin: 0 0 12px 0;">Ventas de Hoy</h2>
                <div id="salesList"></div>
                <button class="btn" onclick="capturarVentas()" style="margin-top: 12px; background: #8b5cf6; color: white; font-size: 14px;">
                    📸 Capturar Ventas del Día
                </button>
            </div>
        </div>
        
        <!-- Vista de Inventario -->
        <div id="inventoryView" class="hide">
            <div class="flex-between" style="margin-bottom: 16px;">
                <h1 style="font-size: 20px; margin: 0;">📦 Inventario</h1>
                <button class="btn btn-primary" onclick="showProductModal()" style="width: auto; padding: 8px 16px;">+ Nuevo</button>
            </div>
            
            <p style="color: #6b7280; margin: 0 0 12px 0;">Productos: <span id="productCount">0</span>/50</p>
            
            <!-- Botones de Backup -->
            <div class="card" style="background: #fef3c7; border: 1px solid #fbbf24;">
                <h3 style="font-size: 14px; margin: 0 0 6px 0;">💾 Backup de Inventario</h3>
                <div class="grid-2" style="gap: 6px;">
                    <button class="btn btn-secondary" onclick="exportarInventario()" style="background: #059669; padding: 8px 12px; font-size: 14px;">
                        📋 Copiar Inventario
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarImportDialog()" style="background: #dc2626; padding: 8px 12px; font-size: 14px;">
                        📥 Restaurar Inventario
                    </button>
                </div>
                <p style="font-size: 11px; color: #78716c; margin: 6px 0 0 0;">
                    Usa estos botones antes de actualizar la app
                </p>
            </div>
            
            <div id="inventoryList"></div>
        </div>
    </div>
    
    <!-- Modal de Producto -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin: 0 0 16px 0;">Nuevo Producto</h2>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label class="form-label">Nombre:</label>
                    <input type="text" id="productName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stock:</label>
                    <input type="number" id="productStock" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Costo:</label>
                    <input type="number" id="productCost" step="0.01" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio:</label>
                    <input type="number" id="productPrice" step="0.01" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Vencimiento:</label>
                    <input type="date" id="productExpiry" class="form-input" required>
                </div>
                
                <div class="grid-2">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="hideProductModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Navegación inferior -->
    <div id="bottomNav" class="bottom-nav hide">
        <button class="btn btn-primary" onclick="showView('main')">🏠 Inicio</button>
    </div>
    
    <script>
        // Variables globales
        let state = {
            inventory: [],
            sales: [],
            currentView: 'main'
        };
        
        let supportBannerDismissed = false;
        let supportModalShown = false;
        
        // Función para mostrar notificaciones
        function showNotification(type, title, message, duration = 4000) {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        ${icons[type]} ${title}
                    </div>
                    <button class="notification-close" onclick="closeNotification(this)">×</button>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    closeNotification(notification.querySelector('.notification-close'));
                }
            }, duration);
        }
        
        function closeNotification(closeBtn) {
            const notification = closeBtn.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
        
        function showCustomModal(icon, title, message, primaryText = 'Entendido', secondaryText = null, onPrimary = null, onSecondary = null) {
            const modal = document.getElementById('customModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalPrimary = document.getElementById('modalPrimary');
            const modalSecondary = document.getElementById('modalSecondary');
            
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalPrimary.textContent = primaryText;
            
            if (secondaryText) {
                modalSecondary.textContent = secondaryText;
                modalSecondary.style.display = 'block';
            } else {
                modalSecondary.style.display = 'none';
            }
            
            modalPrimary.onclick = () => {
                if (onPrimary) onPrimary();
                closeCustomModal();
            };
            
            if (onSecondary) {
                modalSecondary.onclick = () => {
                    onSecondary();
                    closeCustomModal();
                };
            }
            
            modal.classList.add('active');
        }
        
        function closeCustomModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        // Sistema de apoyo
        function showSupportModal() {
            const modal = document.getElementById('supportModal');
            if (modal) {
                modal.classList.add('active');
                supportModalShown = true;
                
                trackEvent('support_modal_opened', {
                    source: 'banner_click',
                    dias_uso: calcularDiasUso()
                });
            }
        }

        function closeSupportModal() {
            const modal = document.getElementById('supportModal');
            if (modal) {
                modal.classList.remove('active');
                
                trackEvent('support_modal_closed', {
                    dias_uso: calcularDiasUso()
                });
            }
        }

        function trackSupportAction(action) {
            trackEvent('support_action', {
                action: action,
                dias_usando_app: calcularDiasUso(),
                total_ventas: state.sales.length,
                total_productos: state.inventory.length
            });
            
            setTimeout(() => {
                const banner = document.getElementById('supportBanner');
                if (banner) {
                    banner.style.display = 'none';
                    localStorage.setItem('support_banner_dismissed', 'true');
                    supportBannerDismissed = true;
                    
                    trackEvent('support_banner_dismissed', {
                        action_taken: action
                    });
                }
                closeSupportModal();
            }, 500);
            
            setTimeout(() => {
                showNotification('success', '💝 ¡Gracias por tu apoyo!', 
                    'Tu apoyo nos ayuda a mantener StoreFlow gratis para todos');
            }, 1000);
        }

        function manageSupportBanner() {
            const banner = document.getElementById('supportBanner');
            if (!banner) return;
            
            const dismissed = localStorage.getItem('support_banner_dismissed');
            if (dismissed) {
                banner.style.display = 'none';
                supportBannerDismissed = true;
                return;
            }
            
            const diasUso = calcularDiasUso();
            const ventasRegistradas = state.sales.length;
            const productosEnInventario = state.inventory.length;
            
            const shouldShow = (diasUso >= 3) || (ventasRegistradas >= 5) || (productosEnInventario >= 10);
            
            if (shouldShow) {
                banner.style.display = 'block';
                
                const bannerShownToday = localStorage.getItem('support_banner_shown_' + new Date().toDateString());
                if (!bannerShownToday) {
                    localStorage.setItem('support_banner_shown_' + new Date().toDateString(), 'true');
                    
                    trackEvent('support_banner_shown', {
                        dias_uso: diasUso,
                        ventas_registradas: ventasRegistradas,
                        productos_inventario: productosEnInventario,
                        trigger: diasUso >= 3 ? 'dias_uso' : (ventasRegistradas >= 5 ? 'ventas' : 'productos')
                    });
                }
            } else {
                banner.style.display = 'none';
            }
        }

        function showSupportAfterSuccess() {
            if (supportBannerDismissed) return;
            
            const banner = document.getElementById('supportBanner');
            if (!banner) return;
            
            const totalVentas = state.sales.length;
            const totalProductos = state.inventory.length;
            
            if (totalVentas === 10) {
                banner.style.display = 'block';
                setTimeout(() => {
                    showNotification('success', '🎉 ¡10 ventas registradas!', 
                        'Estás dominando StoreFlow. Si quieres apoyar el proyecto, revisa la opción de abajo.');
                }, 1500);
                
                trackEvent('milestone_support_shown', {
                    milestone_type: '10_ventas',
                    total_ventas: totalVentas
                });
            }
            
            if (totalProductos === 20) {
                banner.style.display = 'block';
                setTimeout(() => {
                    showNotification('success', '📦 ¡20 productos en inventario!', 
                        'Tu negocio está creciendo. Considera una lona profesional para darle más visibilidad.');
                }, 1500);
                
                trackEvent('milestone_support_shown', {
                    milestone_type: '20_productos',
                    total_productos: totalProductos
                });
            }
        }
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDate();
            updateSummary();
            renderInventory();
            renderSales();
            setInterval(checkMidnight, 60000);
            
            // Configurar modales
            document.getElementById('customModal').addEventListener('click', (e) => {
                if (e.target.id === 'customModal') {
                    closeCustomModal();
                }
            });
            
            const supportModal = document.getElementById('supportModal');
            if (supportModal) {
                supportModal.addEventListener('click', (e) => {
                    if (e.target.id === 'supportModal') {
                        closeSupportModal();
                    }
                });
            }
            
            setTimeout(() => {
                manageSupportBanner();
            }, 2000);
        });
        
        // Funciones de datos
        function loadData() {
            try {
                const savedInventory = localStorage.getItem('tiendita_inventory');
                if (savedInventory) {
                    state.inventory = JSON.parse(savedInventory);
                    trackEvent('inventario_cargado', {
                        productos_count: state.inventory.length
                    });
                } else {
                    state.inventory = [
                        { id: 1, name: 'Coca-Cola 600ml', stock: 24, cost: 12, price: 18, expiry: '2025-08-15' },
                        { id: 2, name: 'Sabritas Original', stock: 15, cost: 8, price: 15, expiry: '2025-07-20' },
                        { id: 3, name: 'Pan Bimbo Grande', stock: 8, cost: 25, price: 35, expiry: '2025-06-25' },
                        { id: 4, name: 'Leche Lala 1L', stock: 12, cost: 18, price: 25, expiry: '2025-06-20' },
                        { id: 5, name: 'Huevos San Juan', stock: 30, cost: 35, price: 50, expiry: '2025-07-01' }
                    ];
                    saveInventory();
                    showNotification('info', 'Bienvenido a StoreFlow', 
                        'Hemos cargado productos de ejemplo para que puedas probar la aplicación');
                    trackEvent('productos_ejemplo_cargados', {
                        productos_count: state.inventory.length
                    });
                }
                
                const today = new Date().toDateString();
                const savedSales = localStorage.getItem('tiendita_sales_' + today);
                if (savedSales) {
                    state.sales = JSON.parse(savedSales);
                    trackEvent('ventas_dia_cargadas', {
                        ventas_count: state.sales.length
                    });
                }
            } catch (e) {
                console.error('Error cargando datos:', e);
                showNotification('error', 'Error de Carga', 
                    'Hubo un problema cargando tus datos. Se inicializará con productos de ejemplo.');
                trackEvent('error_carga_datos', {
                    error_message: e.message
                });
            }
        }
        
        function saveInventory() {
            try {
                localStorage.setItem('tiendita_inventory', JSON.stringify(state.inventory));
                trackEvent('inventario_guardado', {
                    productos_count: state.inventory.length
                });
            } catch (e) {
                console.error('Error guardando inventario:', e);
                showNotification('error', 'Error de Guardado', 
                    'No se pudo guardar el inventario. Verifica el espacio de almacenamiento.');
                trackEvent('error_guardar_inventario', {
                    error_message: e.message
                });
            }
        }
        
        function saveSales() {
            try {
                const today = new Date().toDateString();
                localStorage.setItem('tiendita_sales_' + today, JSON.stringify(state.sales));
                trackEvent('ventas_guardadas', {
                    ventas_count: state.sales.length
                });
            } catch (e) {
                console.error('Error guardando ventas:', e);
                showNotification('error', 'Error de Guardado', 
                    'No se pudieron guardar las ventas del día.');
                trackEvent('error_guardar_ventas', {
                    error_message: e.message
                });
            }
        }
        
        // Funciones de UI
        function showView(view) {
            document.getElementById('mainView').classList.toggle('hide', view !== 'main');
            document.getElementById('salesView').classList.toggle('hide', view !== 'sales');
            document.getElementById('inventoryView').classList.toggle('hide', view !== 'inventory');
            document.getElementById('bottomNav').classList.toggle('hide', view === 'main');
            
            state.currentView = view;
            
            trackEvent('vista_navegada', {
                vista_destino: view
            });
            
            if (view === 'sales') {
                updateSaleProductList();
                trackEvent('vista_ventas_abierta');
            } else if (view === 'inventory') {
                trackEvent('vista_inventario_abierta');
            }
        }
        
        function updateDate() {
            const date = new Date().toLocaleDateString('es-MX', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long' 
            });
            document.getElementById('navbar').textContent = date;
        }
        
        function updateSummary() {
            const summary = state.sales.reduce((acc, sale) => {
                acc.totalSales += sale.total;
                acc.totalProfit += (sale.total - (sale.cost * sale.quantity));
                acc.totalProducts += sale.quantity;
                return acc;
            }, { totalSales: 0, totalProfit: 0, totalProducts: 0 });
            
            document.getElementById('totalSales').textContent = summary.totalSales.toFixed(2);
            document.getElementById('totalProfit').textContent = summary.totalProfit.toFixed(2);
            document.getElementById('totalProducts').textContent = summary.totalProducts;
        }
        
        // Calculadora
        function calculate() {
            const cost = parseFloat(document.getElementById('calcCost').value) || 0;
            const price = parseFloat(document.getElementById('calcPrice').value) || 0;
            const qty = parseInt(document.getElementById('calcQty').value) || 1;
            
            if (cost > 0 && price > 0) {
                const margin = ((price - cost) / cost) * 100;
                const profit = (price - cost) * qty;
                
                document.getElementById('calcMargin').textContent = margin.toFixed(1);
                document.getElementById('calcProfit').textContent = profit.toFixed(2);
                document.getElementById('calcResult').classList.remove('hide');
                
                trackEvent('calculadora_usada', {
                    margen_calculado: margin.toFixed(1),
                    ganancia_calculada: profit.toFixed(2)
                });
            } else {
                document.getElementById('calcResult').classList.add('hide');
            }
        }
        
        // Ventas
        function updateSaleProductList() {
            const select = document.getElementById('saleProduct');
            select.innerHTML = '<option value="">Selecciona...</option>';
            
            state.inventory
                .filter(p => p.stock > 0)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} - ${product.price} (${product.stock})`;
                    select.appendChild(option);
                });
        }
        
        function updateSaleTotal() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQty').value) || 0;
            
            if (productId) {
                const product = state.inventory.find(p => p.id === productId);
                if (product) {
                    const total = product.price * quantity;
                    document.getElementById('saleTotal').textContent = total.toFixed(2);
                }
            } else {
                document.getElementById('saleTotal').textContent = '0.00';
            }
        }
        
        function changeSaleQty(delta) {
            const input = document.getElementById('saleQty');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
            updateSaleTotal();
        }
        
        function registerSale(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQty').value);
            
            const product = state.inventory.find(p => p.id === productId);
            if (!product) return;
            
            if (product.stock < quantity) {
                showNotification('error', 'Stock Insuficiente', 
                    `Solo quedan ${product.stock} unidades de ${product.name}`);
                trackEvent('error_stock_insuficiente', {
                    producto_id: productId,
                    stock_disponible: product.stock,
                    cantidad_solicitada: quantity
                });
                return;
            }
            
            const sale = {
                id: Date.now(),
                productName: product.name,
                quantity: quantity,
                price: product.price,
                cost: product.cost,
                total: product.price * quantity,
                time: new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })
            };
            
            state.sales.push(sale);
            product.stock -= quantity;
            
            saveInventory();
            saveSales();
            updateSummary();
            renderSales();
            
            const ganancia = (sale.price - sale.cost) * quantity;
            showNotification('success', 'Venta Registrada', 
                `${quantity} ${product.name} por ${sale.total.toFixed(2)} (Ganancia: ${ganancia.toFixed(2)})`);
            
            trackEvent('venta_registrada', {
                producto_nombre: product.name,
                cantidad: quantity,
                total_venta: sale.total.toFixed(2),
                ganancia: ganancia.toFixed(2)
            });
            
            document.getElementById('saleForm').reset();
            document.getElementById('saleQty').value = 1;
            updateSaleTotal();
            updateSaleProductList();
            
            if (product.stock <= 5 && product.stock > 0) {
                setTimeout(() => {
                    showNotification('warning', 'Stock Bajo', 
                        `Quedan solo ${product.stock} unidades de ${product.name}`);
                }, 1000);
            } else if (product.stock === 0) {
                setTimeout(() => {
                    showNotification('error', 'Producto Agotado', 
                        `${product.name} se ha agotado completamente`);
                }, 1000);
            }
            
            showSupportAfterSuccess();
        }
        
        function renderSales() {
            const container = document.getElementById('salesList');
            
            if (state.sales.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Sin ventas</p>';
                return;
            }
            
            container.innerHTML = state.sales.map(sale => `
                <div class="sale-item">
                    <div class="flex-between">
                        <strong>${sale.productName}</strong>
                        <span>${sale.total.toFixed(2)}</span>
                    </div>
                    <div style="font-size: 12px; color: #6b7280;">
                        ${sale.quantity} unidades • ${sale.time}
                    </div>
                </div>
            `).join('');
        }
        
        // Inventario
        function renderInventory() {
            const container = document.getElementById('inventoryList');
            document.getElementById('productCount').textContent = state.inventory.length;
            
            if (state.inventory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">Sin productos</p>';
                return;
            }
            
            const sortedInventory = [...state.inventory].sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = sortedInventory.map(product => `
                <div class="product-item">
                    <div class="flex-between">
                        <strong>${product.name}</strong>
                        <div>
                            <button onclick="editProduct(${product.id})" style="background: none; border: none; font-size: 18px; cursor: pointer;">✏️</button>
                            <button onclick="deleteProduct(${product.id})" style="background: none; border: none; font-size: 18px; cursor: pointer;">🗑️</button>
                        </div>
                    </div>
                    <div style="font-size: 14px;">
                        <div>Stock: ${product.stock} | Precio: ${product.price}</div>
                        <div>Costo: ${product.cost} | Vence: ${new Date(product.expiry).toLocaleDateString('es-MX')}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function showProductModal(product = null) {
            if (product) {
                document.getElementById('modalTitle').textContent = 'Editar Producto';
                document.getElementById('productId').value = product.id;
                document.getElementById('productName').value = product.name;
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCost').value = product.cost;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productExpiry').value = product.expiry;
                
                trackEvent('modal_editar_producto_abierto', {
                    producto_id: product.id,
                    producto_nombre: product.name
                });
            } else {
                document.getElementById('modalTitle').textContent = 'Nuevo Producto';
                document.getElementById('productForm').reset();
                document.getElementById('productId').value = '';
                
                trackEvent('modal_nuevo_producto_abierto');
            }
            
            document.getElementById('productModal').classList.add('active');
        }
        
        function hideProductModal() {
            document.getElementById('productModal').classList.remove('active');
            trackEvent('modal_producto_cerrado');
        }
        
        function editProduct(id) {
            const product = state.inventory.find(p => p.id === id);
            if (product) {
                showProductModal(product);
            }
        }
        
        function deleteProduct(id) {
            const product = state.inventory.find(p => p.id === id);
            if (!product) return;
            
            showCustomModal(
                '🗑️',
                'Eliminar Producto',
                `¿Estás seguro de eliminar "${product.name}"? Esta acción no se puede deshacer.`,
                'Eliminar',
                'Cancelar',
                () => {
                    state.inventory = state.inventory.filter(p => p.id !== id);
                    saveInventory();
                    renderInventory();
                    updateSaleProductList();
                    
                    showNotification('success', 'Producto Eliminado', 
                        `${product.name} ha sido eliminado del inventario`);
                    
                    trackEvent('producto_eliminado', {
                        producto_id: id,
                        producto_nombre: product.name
                    });
                },
                () => {
                    trackEvent('eliminacion_producto_cancelada', {
                        producto_id: id
                    });
                }
            );
        }
        
        function saveProduct(event) {
            event.preventDefault();
            
            const id = document.getElementById('productId').value;
            const product = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('productName').value.trim(),
                stock: parseInt(document.getElementById('productStock').value),
                cost: parseFloat(document.getElementById('productCost').value),
                price: parseFloat(document.getElementById('productPrice').value),
                expiry: document.getElementById('productExpiry').value
            };
            
            if (product.price <= product.cost) {
                showNotification('warning', 'Precio Incorrecto', 
                    'El precio de venta debe ser mayor al costo');
                return;
            }
            
            if (id) {
                const index = state.inventory.findIndex(p => p.id === product.id);
                if (index !== -1) {
                    state.inventory[index] = product;
                    showNotification('success', 'Producto Actualizado', 
                        `${product.name} ha sido actualizado correctamente`);
                    trackEvent('producto_editado', {
                        producto_id: product.id,
                        producto_nombre: product.name
                    });
                }
            } else {
                if (state.inventory.length >= 50) {
                    showNotification('error', 'Límite Alcanzado', 
                        'Máximo 50 productos. Elimina algunos productos para agregar nuevos.');
                    trackEvent('limite_productos_alcanzado', {
                        productos_actuales: state.inventory.length
                    });
                    return;
                }
                state.inventory.push(product);
                showNotification('success', 'Producto Agregado', 
                    `${product.name} se agregó al inventario`);
                trackEvent('producto_agregado', {
                    producto_id: product.id,
                    producto_nombre: product.name,
                    total_productos: state.inventory.length
                });
            }
            
            saveInventory();
            renderInventory();
            updateSaleProductList();
            hideProductModal();
        }
        
        // Utilidades
        function checkMidnight() {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                const ventasAyer = state.sales.length;
                state.sales = [];
                saveSales();
                updateSummary();
                renderSales();
                
                if (ventasAyer > 0) {
                    showNotification('info', 'Nuevo Día', 
                        `Registraste ${ventasAyer} ventas ayer. ¡Que tengas un excelente día de ventas!`);
                }
                trackEvent('nuevo_dia_iniciado', {
                    ventas_dia_anterior: ventasAyer
                });
            }
        }
        
        function calcularDiasUso() {
            let primerUso = localStorage.getItem('tiendita_primer_uso');
            
            if (!primerUso) {
                primerUso = new Date().toISOString();
                localStorage.setItem('tiendita_primer_uso', primerUso);
                trackEvent('primer_uso_registrado');
                return 1;
            }
            
            const fechaInicio = new Date(primerUso);
            const fechaHoy = new Date();
            const diferencia = fechaHoy - fechaInicio;
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24)) + 1;
            
            return dias;
        }
        
        function enviarFeedback() {
            const diasUso = calcularDiasUso();
            const ventasHoy = state.sales.length;
            const totalVentasHoy = state.sales.reduce((sum, s) => sum + s.total, 0);
            const totalProductos = state.inventory.length;
            
            const mensaje = `🏪 *Feedback StoreFlow*\n\n` +
                `📊 *Mis estadísticas:*\n` +
                `• Días usando la app: ${diasUso}\n` +
                `• Productos en inventario: ${totalProductos}\n` +
                `• Ventas registradas hoy: ${ventasHoy}\n` +
                `• Total vendido hoy: ${totalVentasHoy.toFixed(2)}\n\n` +
                `💭 *Mi experiencia:*\n` +
                `(Escribe aquí qué te gusta, qué mejorarías o cualquier comentario)\n\n` +
                `⭐ *Calificación:* _/5`;
            
            const numeroWhatsApp = '525564290144';
            const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
            
            trackEvent('feedback_whatsapp_enviado', {
                dias_uso: diasUso,
                productos_inventario: totalProductos,
                ventas_hoy: ventasHoy,
                total_ventas_hoy: totalVentasHoy.toFixed(2)
            });
            
            showCustomModal(
                '📱',
                'Abrir WhatsApp',
                'Se abrirá WhatsApp con un mensaje prellenado con tus estadísticas. ¿Continuar?',
                'Abrir WhatsApp',
                'Cancelar',
                () => {
                    window.open(url, '_blank');
                    showNotification('success', 'WhatsApp Abierto', 
                        'Gracias por ayudarnos a mejorar StoreFlow');
                }
            );
        }
        
        // Funciones de backup (simplificadas)
        function exportarInventario() {
            if (state.inventory.length === 0) {
                showNotification('warning', 'Sin Productos', 
                    'No hay productos para exportar');
                return;
            }
            
            const backup = {
                version: '1.0',
                fecha: new Date().toLocaleString('es-MX'),
                totalProductos: state.inventory.length,
                productos: state.inventory
            };
            
            const textoBackup = JSON.stringify(backup);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textoBackup).then(() => {
                    showNotification('success', 'Backup Completado', 
                        `${state.inventory.length} productos copiados al portapapeles. Guárdalo en WhatsApp o Notas.`);
                });
            } else {
                showNotification('info', 'Backup Listo', 
                    'Presiona Ctrl+C para copiar el backup');
            }
        }
        
        function mostrarImportDialog() {
            showCustomModal(
                '📥',
                'Restaurar Inventario',
                'Esta función permite restaurar tu inventario desde un backup previo.',
                'Entendido'
            );
        }
        
        function capturarVentas() {
            showNotification('info', 'Funcionalidad en Desarrollo', 
                'La captura de ventas estará disponible en la próxima actualización');
        }
    </script>
</body>
</html>
